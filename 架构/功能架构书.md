# 项目模块增强实现计划

**版本：** 1.0
**日期：** 2025-05-14 <!-- 实际日期已替换 -->
**制定人：** Roo (AI Technical Leader)

**目标：** 为现有 Java Web 商城项目添加商品详情、支付（模拟）和个人中心三个核心模块。

草稿： 1.注册页面区分用户名和用户昵称（参考数据库）

---

## 一、 商品详情模块

### 1.1 功能描述：

    *   用户在首页 (`web/index.jsp`) 点击商品卡片（图片或名称）后，跳转到该商品的专属详情页面。
    *   商品详情页展示商品的多张图片（主图+缩略图切换，主图和附加图均为图片URL，直接用URL展示），价格，详细描述（来自 `product.detail`），花语（来自 `product.detail`）。
    *   提供“加入购物车”按钮。
    *   提供“立即购买”按钮（行为：加入购物车并跳转到购物车页面）。

### 1.2 前端实现 (`productDetail.jsp` - 新建)：

    *   **页面布局：**
        *   左侧：商品图片展示区。
            *   主图显示区域：默认展示商品的第一张图片（即首页列表的展示图，直接用图片URL）。
            *   缩略图列表：位于主图下方，陈列商品所有图片（主图及附加图片，均为URL）。点击任一缩略图，主图区域相应更新。
        *   右侧：商品信息与操作区。
            *   顶部：商品核心信息（如商品名称, 价格, 从 `product.detail` 提取的详细描述文字, 从 `product.detail` 提取的花语）。
            *   中部：相关规格选择区。
                *   展示与当前商品属于同一产品系列（相同 `product_id`）的其他可选规格。
                *   每个规格选项以图片和中文规格描述（来自 `goods.ch_spec`）的形式展示，图片为URL。
                *   点击某个规格选项，页面跳转到该规格商品的详情页 (`/productDetail?id=${规格商品.id}`)。
            *   底部（样式参考用户提供的图片）：
                *   数量选择器：包含数量输入框（默认为1）及用于增加/减少数量的按钮。
                *   “加入购物车”按钮。
                *   “立即购买”按钮。
            *   *注：此页面不包含“服务承诺”、“分期付款”等部分的展示。*
    *   **数据来源：** 由 `ProductDetailServlet` 通过 `request.setAttribute()` 传递 (`goods` 对象, `productDetailText` 字符串, `additionalImages` 列表, `relatedGoodsList` 列表)。
    *   **交互：**
        *   图片切换：通过客户端 JavaScript 实现缩略图点击切换主图。
        *   规格切换：点击相关规格选项，直接通过链接跳转。
        *   数量调整：通过客户端 JavaScript 控制数量输入框的值。
        *   “加入购物车”按钮：GET 请求到 `/session?id=${goods.id}&num=${selected_quantity}` (其中 `selected_quantity` 为用户选择的数量)。
        *   “立即购买”按钮：GET 请求到 `/session?id=${goods.id}&num=${selected_quantity}&buyNow=true`。

### 1.3 后端实现 (`ProductDetailServlet.java` - 新建)：

    *   **URL 映射：** `@WebServlet("/productDetail")`
    *   **`doGet` 方法逻辑：**
        1.  获取并校验商品 `id`。
        2.  调用服务层获取当前 `Goods` 对象 (`currentGoods`)。
        3.  通过 `currentGoods.getProduct_id()` 调用服务层获取 `Product` 对象，从中提取 `detail` 文本 (`productDetailText`)。
        4.  直接使用数据库中存储的主图和附加图片URL，构建图片URL列表 (`additionalImages`)，无需本地文件系统查找。
        5.  使用 `currentGoods.getProduct_id()` 调用服务层查询 `goods` 表，获取所有具有相同 `product_id` 的 `Goods` 对象列表 (`relatedGoodsList`)，图片均为URL。
        6.  将 `currentGoods`, `productDetailText`, `additionalImages`, `relatedGoodsList` 存入 `request`。
        7.  转发到 `productDetail.jsp`。

### 1.4 数据库交互：

    *   查询 `goods` 表 (by `id`) 获取当前商品。
    *   查询 `product` 表 (by `goods.product_id`) 获取产品详情。
    *   查询 `goods` 表 (by `product_id`) 获取相关规格的商品列表。

### 1.5 对现有文件的修改：

    *   `web/index.jsp`: 修改商品链接指向 `/productDetail?id=${goods.id}`。
    *   `src/com/yang/controller/SessionServlet.java`:
        *   在加入购物车逻辑中，接收并处理新增的 `num` (数量) 参数。
        *   在加入购物车逻辑后，检查 `buyNow` 参数，若为 `true` 则重定向到 `/shopCart`，否则重定向到 `/index`。

---

## 二、 支付模块 (模拟)

### 2.1 功能描述：

    *   用户在购物车页面 (`web/shoppingCart.jsp`) 点击“去结算”。
    *   跳转到模拟支付页面，显示订单概要（选中商品列表、总金额）。
    *   用户点击“确认支付”。
    *   跳转到支付结果页面，显示“支付成功”。
    *   支付成功后，清空购物车中所有商品。
    *   购物车数量修改和删除操作仅在前端临时生效，结算时提交最终状态。

### 2.2 前端实现：

    *   **`web/shoppingCart.jsp` 修改：**
        *   动态显示商品规格 (来自 `item.goods.ch_spec`)。
        *   “去结算”按钮 (`jsBtn`)：点击时，收集选中商品的 `id` 和最终 `quantity`，通过动态创建的表单 POST 到 `/preparePayment`。确保商品 `id` 在页面行中可用 (例如通过 `data-goodsid` 属性)。
        *   数量增减和删除的JS逻辑已移至外部JS文件，仅影响前端视图，不实时与后端交互。
    *   **`payment.jsp` (新建)：**
        *   显示订单概要 (商品列表, 总金额) - 数据来自 `PreparePaymentServlet`。
        *   “确认支付”按钮 (POST 到 `/processPayment`)。
    *   **`paymentResult.jsp` (新建)：**
        *   显示支付结果消息。
        *   提供“返回首页”链接。

### 2.3 后端实现：

    *   **`PreparePaymentServlet.java` (新建)：**
        *   **URL 映射：** `@WebServlet("/preparePayment")`
        *   **`doPost` 方法逻辑：**
            1.  检查登录。
            2.  获取提交的选中商品 `id` 数组和 `num` 数组。
            3.  根据这些信息，从 `session` 中的完整 `cart` (或重新查询数据库) 构建仅包含选中商品的 `List<GoodsItem>` (`paymentItems`)。
            4.  计算总金额 (`paymentTotal`)。
            5.  将 `paymentItems` 和 `paymentTotal` 存入 `session` (或 `request`)。
            6.  转发到 `payment.jsp`。
    *   **`ProcessPaymentServlet.java` (新建)：**
        *   **URL 映射：** `@WebServlet("/processPayment")`
        *   **`doPost` 方法逻辑：**
            1.  检查登录。
            2.  (模拟支付成功)。
            3.  清空 `session` 中的 `cart` (`req.getSession().removeAttribute("cart");`)。
            4.  设置成功消息存入 `request`。
            5.  转发到 `paymentResult.jsp`。

### 2.4 数据库交互：

    *   此简化版支付模块主要操作 `session`。`PreparePaymentServlet` 可能会为构建 `paymentItems` 而查询 `goods` 表。

---

## 三、 个人中心模块

### 3.1 功能描述：

    *   用户访问个人中心页面 (`infoCenter.jsp`，需要新建)。
    *   可查看和修改个人基本信息（电话、邮箱、性别）。
    *   可修改登录密码（不加密存储）。
    *   可上传/更改头像（存储在服务器文件系统 `web/user_avatars/`，数据库存路径）。
    *   可管理一个收货地址（不支持多个）。

### 3.2 前端实现 (`infoCenter.jsp` - 新建)：

    *   **页面布局：**
        *   区域1：显示当前用户信息 (头像, 用户名, 电话, 邮箱, 性别)。
        *   区域2：修改个人资料表单 (电话, 邮箱, 性别; 提交到 `/updateProfile`)。
        *   区域3：修改密码表单 (旧密码, 新密码, 确认新密码; 提交到 `/updatePassword`)。
        *   区域4：上传头像表单 (`enctype="multipart/form-data"`; 提交到 `/uploadAvatar`)。
        *   区域5：管理收货地址表单 (收件人, 电话, 省市区详情等; 提交到 `/manageAddress`)。
    *   **数据来源：** `Customer` 对象和 `Address` 对象 (可能为 `null`) 由 `InfoCenterServlet` 传递。

### 3.3 后端实现：

    *   **`InfoCenterServlet.java` 修改：**
        *   **URL 映射：** `@WebServlet("/infoCenter")`
        *   **`doGet/doPost` 方法逻辑：**
            1.  检查登录。
            2.  获取 `Customer` 对象。
            3.  调用服务层根据 `customer.id` 查询其 `Address` 对象。
            4.  将 `customer` 和 `address` 存入 `request`。
            5.  转发到新建的 `infoCenter.jsp`。
    *   **`UpdateProfileServlet.java` (新建)：**
        *   **URL 映射：** `@WebServlet("/updateProfile")`
        *   **`doPost` 方法逻辑：** 更新 `Customer` 的 `tel`, `email`, `gender`；更新数据库和 `session`；重定向到 `/infoCenter`。
    *   **`UpdatePasswordServlet.java` (新建)：**
        *   **URL 映射：** `@WebServlet("/updatePassword")`
        *   **`doPost` 方法逻辑：** 验证旧密码，更新 `Customer` 的 `pass`；更新数据库；重定向到 `/infoCenter`。
    *   **`UploadAvatarServlet.java` (新建)：**
        *   **URL 映射：** `@WebServlet("/uploadAvatar")`
        *   **`doPost` 方法逻辑：** 处理文件上传，保存到 `web/user_avatars/`，更新 `Customer` 的 `imgUrl`；更新数据库和 `session`；重定向到 `/infoCenter`。
    *   **`ManageAddressServlet.java` (新建)：**
        *   **URL 映射：** `@WebServlet("/manageAddress")`
        *   **`doPost` 方法逻辑：** 获取地址信息，根据 `customer_id` 查询现有地址，有则更新，无则插入；重定向到 `/infoCenter`。

### 3.4 数据库交互：

    *   `customer` 表：更新 `tel`, `email`, `gender`, `pass`, `imgUrl`。
    *   `address` 表：查询、插入或更新用户的单个地址记录。

---

## 四、 高层模块交互示意图 (Mermaid)

```mermaid
graph TD
    A[用户浏览器] --> Z(Phase 0: Refactor CSS/JS);
    Z --> B(index.jsp);
    B -- 点击商品 --> C(ProductDetailServlet);
    C -- 查询商品/产品数据 --> D[数据库 (goods, product)];
    C --> E(productDetail.jsp);
    E -- 加入购物车/立即购买 --> F(SessionServlet);
    F -- 更新Session Cart --> G[HttpSession];
    F -- 立即购买时重定向 --> H(shopCart.jsp);
    B -- 点击购物车图标 --> I(shopCartServlet);
    I --> H;
    H -- 显示Session Cart --> G;
    H -- 去结算 --> J(PreparePaymentServlet);
    J -- 处理选中商品 --> G;
    J --> K(payment.jsp);
    K -- 确认支付 --> L(ProcessPaymentServlet);
    L -- 清空Session Cart --> G;
    L --> M(paymentResult.jsp);

    A -- 访问个人中心 --> N(InfoCenterServlet);
    N -- 查询用户/地址数据 --> O[数据库 (customer, address)];
    N --> P(infoCenter.jsp);
    P -- 修改资料 --> Q(UpdateProfileServlet);
    P -- 修改密码 --> R(UpdatePasswordServlet);
    P -- 上传头像 --> S(UploadAvatarServlet);
    P -- 管理地址 --> T(ManageAddressServlet);
    Q --> O;
    R --> O;
    S -- 保存头像文件 & 更新DB --> U[文件系统 /web/user_avatars];
    S --> O;
    T --> O;
```

---

## 五、 待后续讨论/决策点 (在实现阶段)：

- `product.detail` 字段中，商品详细描述和花语的具体分隔/提取方式。
- 省市县地址输入的具体实现方式（若个人中心地址管理需要简化）。
- SQL 清理的具体范围，需在开发助手分析后与您确认。
